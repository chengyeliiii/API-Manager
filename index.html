<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Manager</title>
    <!-- 新增：浏览器图标 -->
    <link rel="icon" type="image/png" href="https://i.postimg.cc/dtDnxc3H/chan-101.png">
    <style>
        /* --- CSS变量 --- */
        :root {
            --bg-color: #fff0f5;
            --main-pink: #ff85a2;
            --light-pink: #ffdbe5;
            --text-color: #5c5c5c;
            --border-color: #ffc2d1;
            --shadow-color: rgba(255, 133, 162, 0.2);
            --default-avatar: url('https://i.postimg.cc/6QsJcRWL/1.jpg');
        }

        /* --- 固定页面布局 & 全屏化 --- */
        html, body {
            height: 100%;
            overflow: hidden; /* 防止页面级别滚动 */
        }

        /* --- 全局样式 --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); /* 保留背景色，以防万一 */
            color: var(--text-color);
            margin: 0;
            padding: 0; /* 移除padding，让容器全屏 */
            box-sizing: border-box;
        }

        /* --- 容器 --- */
        .container {
            width: 100%; 
            margin: 0;
            background-color: white;
            border-radius: 0; /* 变为直角，融入全屏 */
            box-shadow: none; /* 全屏模式下阴影意义不大，可以移除 */
            padding: 20px 30px; /* 保持内部边距 */
            height: 100%;
            overflow-y: auto;
            box-sizing: border-box;
        }
        
        #detailPage { display: none; }

        /* --- 标题 --- */
        h1, h2 { color: var(--main-pink); text-align: center; }
        
        /* --- 通用按钮样式 --- */
        button, .button {
            background-color: var(--main-pink);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        button:hover, .button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px var(--shadow-color); }

        /* --- 主页 --- */
        .header { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; }
        #apiList { display: grid; gap: 12px; }
        .api-card {
            background-color: white;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 6px var(--shadow-color);
            padding: 10px 15px;
            border-radius: 12px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
        }
        .api-card:hover { transform: scale(1.02); box-shadow: 0 6px 12px var(--shadow-color); }
        .api-card-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
            border: 2px solid var(--light-pink);
        }

        /* --- 详情页 --- */
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .detail-header button { padding: 6px 14px; font-size: 14px; }
        
        #apiImagePreview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--border-color);
            display: block;
            margin: 0 auto 20px auto;
        }
        #formContainer:not(.readonly) #apiImagePreview {
            cursor: pointer;
            transition: transform 0.2s;
        }
        #formContainer:not(.readonly) #apiImagePreview:hover {
            transform: scale(1.05);
            border-color: var(--main-pink);
        }

        #formContainer.readonly input { background-color: #f9f9f9; pointer-events: none; border-color: #eee; }
        
        #formContainer.readonly .key-item input,
        #formContainer.readonly #apiUrlInput {
            cursor: copy;
            pointer-events: auto;
            transition: background-color 0.2s;
        }
        #formContainer.readonly .key-item input:hover,
        #formContainer.readonly #apiUrlInput:hover {
            background-color: var(--light-pink);
        }

        #formContainer.readonly .delete-key-btn, #formContainer.readonly #addKeyBtn { display: none; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--main-pink); }
        input[type="text"] {
            width: 100%; padding: 12px; border: 2px solid var(--border-color);
            border-radius: 10px; box-sizing: border-box; font-size: 16px; transition: border-color 0.3s, background-color 0.3s, color 0.2s;
        }
        input[type="text"]:focus { outline: none; border-color: var(--main-pink); }
        .key-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .key-item input { flex-grow: 1; }

        .delete-key-btn {
            background: none;
            border: 1px solid var(--light-pink);
            color: var(--main-pink);
            font-size: 20px;
            cursor: pointer;
            padding: 0 8px;
            border-radius: 8px;
            line-height: 1.4;
            transition: background-color 0.2s, transform 0.2s;
        }
        .delete-key-btn:hover {
            background-color: var(--bg-color);
            transform: scale(1.1);
        }


        /* --- 右下角浮动添加按钮 --- */
        #addApiBtn {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; border-radius: 50%; z-index: 1000;
            background-color: transparent;
            background-image: url('https://i.postimg.cc/BvPk1v2L/cookies-26.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            box-shadow: none; border: none; transition: transform 0.2s ease-in-out, opacity 0.3s;
        }
        #addApiBtn:hover { transform: scale(1.1) rotate(15deg); box-shadow: none; }
    </style>
</head>
<body>

    <div class="container">
        <!-- 主页 -->
        <div id="mainPage">
            <div class="header"><h1>API Manager</h1></div>
            <div id="apiList"></div>
        </div>

        <!-- 详情/编辑页 -->
        <div id="detailPage">
            <div class="detail-header">
                <button id="backBtn">返回</button>
                <h2 id="detailApiName">API 配置</h2>
                <div>
                    <button id="editBtn">编辑</button>
                    <button id="saveBtn" style="display: none;">保存</button>
                </div>
            </div>
            <div id="formContainer">
                <input type="hidden" id="apiIdInput">
                
                <div class="form-group">
                    <label>头像</label>
                    <img id="apiImagePreview" src="" alt="API Avatar Preview">
                    <input type="file" id="apiImageInput" accept="image/*" style="display: none;">
                </div>

                <div class="form-group">
                    <label for="apiUrlInput">反代地址 (URL)</label>
                    <input type="text" id="apiUrlInput" placeholder="忘记v1就咬你喵！">
                </div>
                <div class="form-group">
                    <label>密钥 (Keys)</label>
                    <div id="keyList"></div>
                    <button id="addKeyBtn" style="margin-top: 10px;">+ 添加密钥</button>
                </div>
            </div>
        </div>
    </div>

    <button id="addApiBtn" title="添加新的API"></button>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 元素获取 ---
            const mainPage = document.getElementById('mainPage'),
                  detailPage = document.getElementById('detailPage'),
                  addApiBtn = document.getElementById('addApiBtn'),
                  backBtn = document.getElementById('backBtn'),
                  apiList = document.getElementById('apiList'),
                  detailApiName = document.getElementById('detailApiName'),
                  formContainer = document.getElementById('formContainer'),
                  apiIdInput = document.getElementById('apiIdInput'),
                  apiImagePreview = document.getElementById('apiImagePreview'),
                  apiImageInput = document.getElementById('apiImageInput'),
                  apiUrlInput = document.getElementById('apiUrlInput'),
                  keyList = document.getElementById('keyList'),
                  addKeyBtn = document.getElementById('addKeyBtn'),
                  editBtn = document.getElementById('editBtn'),
                  saveBtn = document.getElementById('saveBtn');

            // --- 全局变量 ---
            const DEFAULT_AVATAR = 'https://i.postimg.cc/6QsJcRWL/1.jpg';
            let db;
            const dbName = 'ApiManagerDB';
            const storeName = 'apis';
            
            // --- IndexedDB 初始化 ---
            const request = indexedDB.open(dbName, 1);
            request.onerror = (e) => console.error("数据库打开失败:", e.target.errorCode);
            request.onsuccess = (e) => { db = e.target.result; renderApiList(); };
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains(storeName)) {
                    db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                }
            };
            
            // --- 页面切换 ---
            const showMainPage = () => {
                mainPage.style.display = 'block';
                detailPage.style.display = 'none';
                addApiBtn.style.display = 'block';
                renderApiList();
            };
            const showDetailPage = () => {
                mainPage.style.display = 'none';
                detailPage.style.display = 'block';
                addApiBtn.style.display = 'none';
            };
            
            // --- 渲染API列表 ---
            const renderApiList = () => {
                if (!db) return;
                const transaction = db.transaction(storeName, 'readonly');
                const objectStore = transaction.objectStore(storeName);
                objectStore.getAll().onsuccess = (e) => {
                    apiList.innerHTML = ''; 
                    const apis = e.target.result;
                    if (apis.length === 0) {
                        apiList.innerHTML = '<p style="text-align:center; color:#aaa;">列表为空，请点击右下角按钮添加新的 API 配置。</p>';
                    } else {
                        apis.forEach(api => {
                            const card = document.createElement('div');
                            card.className = 'api-card'; card.dataset.id = api.id;
                            const avatar = document.createElement('img');
                            avatar.className = 'api-card-avatar';
                            avatar.src = api.imageDataUrl || DEFAULT_AVATAR;
                            const nameSpan = document.createElement('span');
                            nameSpan.textContent = api.name;
                            card.append(avatar, nameSpan);
                            let pressTimer = null, isLongPress = false;
                            const startPress = (event) => {
                                if (event.type === 'mousedown' && event.button !== 0) return;
                                isLongPress = false;
                                pressTimer = setTimeout(() => {
                                    isLongPress = true;
                                    if (confirm(`确定要删除 "${api.name}" 吗？`)) deleteApi(api.id);
                                }, 700);
                            };
                            const cancelPress = () => clearTimeout(pressTimer);
                            card.addEventListener('click', (event) => {
                                if (isLongPress) {
                                    event.preventDefault();
                                    event.stopPropagation();
                                } else {
                                    loadApiDetails(api.id);
                                }
                            });
                            card.addEventListener('mousedown', startPress);
                            card.addEventListener('touchstart', startPress, { passive: true });
                            card.addEventListener('mouseup', cancelPress);
                            card.addEventListener('mouseleave', cancelPress);
                            card.addEventListener('touchend', cancelPress);
                            card.addEventListener('touchmove', cancelPress); 
                            card.addEventListener('contextmenu', e => e.preventDefault());
                            apiList.appendChild(card);
                        });
                    }
                };
            };
            
            // --- 加载API详情 ---
            const loadApiDetails = (id) => {
                db.transaction(storeName, 'readonly').objectStore(storeName).get(id).onsuccess = (e) => {
                    const api = e.target.result;
                    if (api) {
                        apiIdInput.value = api.id;
                        detailApiName.textContent = api.name;
                        apiImagePreview.src = api.imageDataUrl || DEFAULT_AVATAR;
                        apiUrlInput.value = api.url || '';
                        renderKeyList(api.keys || []);
                        setReadonlyState(true); 
                        showDetailPage();
                    }
                };
            };

            const renderKeyList = (keys) => {
                keyList.innerHTML = '';
                if (keys.length === 0) keys.push('');
                keys.forEach(key => addKeyInput(key));
            };

            // --- 修改：增加“锁”来防止重复复制 ---
            const copyOnClick = (inputElement) => {
                // 如果元素正处于“复制中”的状态，则直接返回
                if (inputElement.dataset.isCopying) {
                    return;
                }
                
                if (formContainer.classList.contains('readonly') && inputElement.value.trim() !== '') {
                    // 上锁
                    inputElement.dataset.isCopying = 'true';

                    const originalValue = inputElement.value;
                    const originalColor = inputElement.style.color;

                    navigator.clipboard.writeText(originalValue).then(() => {
                        inputElement.value = '已复制!';
                        inputElement.style.color = 'var(--main-pink)';
                        setTimeout(() => {
                            inputElement.value = originalValue;
                            inputElement.style.color = originalColor;
                            // 延时后解锁
                            delete inputElement.dataset.isCopying;
                        }, 1500);
                    }).catch(err => {
                        console.error('复制失败:', err);
                        alert('复制失败，请检查浏览器设置或权限。');
                        // 如果复制失败也要解锁
                        delete inputElement.dataset.isCopying;
                    });
                }
            };
            
            const addKeyInput = (value = '') => {
                const keyItem = document.createElement('div');
                keyItem.className = 'key-item';
                const input = document.createElement('input');
                input.type = 'text'; input.value = value; input.placeholder = '填写密钥喵～';
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-key-btn'; deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => { if (keyList.children.length > 1) keyItem.remove(); };
                
                input.addEventListener('click', () => copyOnClick(input));

                keyItem.append(input, deleteBtn);
                keyList.appendChild(keyItem);
            };

            const setReadonlyState = (isReadonly) => {
                formContainer.classList.toggle('readonly', isReadonly);
                editBtn.style.display = isReadonly ? 'inline-block' : 'none';
                saveBtn.style.display = isReadonly ? 'none' : 'inline-block';
            };
            
            // --- 数据库操作 ---
            const addApi = (name) => {
                const newApi = { name: name, url: '', keys: [''], imageDataUrl: null };
                db.transaction(storeName, 'readwrite').objectStore(storeName).add(newApi).onsuccess = () => renderApiList();
            };
            const updateApi = () => {
                const id = parseInt(apiIdInput.value);
                const imageDataUrl = apiImagePreview.src.startsWith('data:image') ? apiImagePreview.src : null;
                const url = apiUrlInput.value.trim();
                const keys = Array.from(keyList.querySelectorAll('input')).map(input => input.value.trim()).filter(key => key);
                
                const transaction = db.transaction(storeName, 'readwrite');
                const objectStore = transaction.objectStore(storeName);
                objectStore.get(id).onsuccess = (e) => {
                    const apiData = e.target.result;
                    apiData.imageDataUrl = imageDataUrl;
                    apiData.url = url;
                    apiData.keys = keys.length > 0 ? keys : [''];
                    
                    objectStore.put(apiData).onsuccess = () => {
                        setReadonlyState(true);
                        alert('保存成功');
                        renderApiList(); 
                    };
                };
            };
            const deleteApi = (id) => {
                db.transaction(storeName, 'readwrite').objectStore(storeName).delete(id).onsuccess = () => renderApiList();
            };

            // --- 事件监听 ---
            addApiBtn.addEventListener('click', () => {
                const apiName = prompt('请输入新的 API 名称：');
                if (apiName && apiName.trim()) addApi(apiName.trim());
            });
            backBtn.addEventListener('click', showMainPage);
            editBtn.addEventListener('click', () => setReadonlyState(false));
            saveBtn.addEventListener('click', updateApi);
            addKeyBtn.addEventListener('click', () => addKeyInput());
            
            apiUrlInput.addEventListener('click', () => copyOnClick(apiUrlInput));

            apiImagePreview.addEventListener('click', () => {
                if (!formContainer.classList.contains('readonly')) {
                    apiImageInput.click();
                }
            });

            apiImageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => apiImagePreview.src = e.target.result;
                    reader.readAsDataURL(file);
                }
            });
        });
    </script>
</body>
</html>
